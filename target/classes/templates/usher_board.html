<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title th:text="${event.name} + ' - Usher board'">Usher board</title>
  <link href="/css/tailwind.css" rel="stylesheet">
  <link href="/css/modern.css" rel="stylesheet">
  <script src="/webjars/sockjs-client/sockjs.min.js"></script>
  <script src="/webjars/stomp-websocket/stomp.min.js"></script>
  <script th:inline="javascript">
    /*<![CDATA[*/
    const EVENT_CODE = /*[[${event.code}]]*/ 'TEST';
    /*]]>*/
  </script>
</head>
<body>
<div class="page">
  <div class="page-header">
    <div>
      <h2 th:text="${event.name} + ' - Usher board'">GLEO Usher board</h2>
      <p class="muted">Track guest pickups across vendors and keep the queue moving.</p>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <!-- Vendor status controls for ushers: choose vendor then mark On Break / Busy / Available -->
      <div th:if="${vendors != null and !#lists.isEmpty(vendors)}" style="display:flex;gap:8px;align-items:center;">
        <label for="vendor-select" class="muted" style="margin-right:6px;">Vendor:</label>
        <select id="vendor-select" class="field-input" style="min-width:180px;padding:6px;border-radius:6px;border:1px solid #e5e7eb;">
          <option th:each="v : ${vendors}" th:value="${v.id}" th:text="${v.name}" th:attr="data-status=${v.status}">Vendor</option>
        </select>
        <span id="vendor-status" class="muted" style="margin-left:8px;min-width:120px;display:inline-block;">Status</span>
        <!-- CSRF values rendered here if available; JS will copy into dynamic form -->
        <input type="hidden" id="_csrf_param" th:if="${_csrf != null}" th:value="${_csrf.parameterName}" />
        <input type="hidden" id="_csrf_token" th:if="${_csrf != null}" th:value="${_csrf.token}" />
        <button type="button" class="btn btn-outline" onclick="submitVendorStatus('BREAK')">On Break</button>
        <button type="button" class="btn btn-outline" onclick="submitVendorStatus('BUSY')">Busy</button>
        <button type="button" class="btn btn-outline" onclick="submitVendorStatus('AVAILABLE')">Available</button>
      </div>

      <!-- Replaced 'Back to guest view' and 'Event policies' with a universal Sign out button -->
      <form th:action="@{/logout}" method="post" style="margin:0;">
        <!-- If CSRF is enabled this will render the token; if disabled it's ignored -->
        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" class="btn btn-muted">Sign out</button>
      </form>
    </div>
  </div>

  <div class="panel" style="margin-bottom:24px;">
    <form method="get" class="usher-filter">
      <label for="ticket-filter">Filter by ticket, serial, or guest name</label>
      <div class="usher-filter-inputs">
        <input id="ticket-filter" name="ticket" type="text" class="qty-input"
               placeholder="e.g. VIP-001 or Sara"
               th:value="${ticketFilter}">
        <button class="btn btn-outline" type="submit">Apply filter</button>
        <a th:href="@{|/e/${event.code}/usher|}" class="btn btn-muted">Clear</a>
      </div>
    </form>

    <div th:if="${message != null}" class="toast toast-success" th:text="${message}">Action saved.</div>
    <div th:if="${error != null}" class="toast toast-error" th:text="${error}">There was a problem.</div>

    <div class="muted" th:if="${requirePin}" style="margin-top:12px;">
      Completing an order requires the vendor PIN for verification.
    </div>
    <div class="muted" th:if="${!guestConfirmEnabled}" style="margin-top:6px;">
      Guest self-confirmation is disabled; ushers must advance orders manually.
    </div>
  </div>

  <div id="usher-board-live"
       th:fragment="board">
    <div th:if="${!hasAnyOrders}" class="card">
      <h3 style="margin-top:0;">No orders yet</h3>
      <p class="muted" style="margin:0;">Orders will appear here as soon as guests check out.</p>
    </div>

    <div class="usher-grid" th:if="${hasAnyOrders}">
      <div class="usher-column" th:each="bucket : ${statusBuckets}">
        <div class="usher-column-header card">
          <div>
            <h3 th:text="${bucket.label}">Status label</h3>
            <span class="muted" th:text="${bucket.orders.size()} + ' order(s)'">0 orders</span>
          </div>
        </div>

        <p class="muted" th:if="${!bucket.hasOrders()}">Nothing queued in this column.</p>

        <div class="usher-order-card" th:each="order : ${bucket.orders}">
          <div class="usher-order-top">
            <div class="vendor-block">
              <div th:if="${order.vendor.imagePath != null}">
                <img th:src="${order.vendor.imagePath}" alt="Vendor" class="vendor-avatar"/>
              </div>
              <div th:if="${order.vendor.imagePath == null}" class="vendor-avatar vendor-initial" role="img" aria-label="Vendor initials"
                   th:text="${#strings.substring(order.vendor.name,0,1).toUpperCase()}"></div>

              <div class="vendor-info">
                <div class="vendor-name" th:text="${order.vendor.name}">Vendor</div>
                <div class="order-meta small muted">
                  <span th:text="'Order #' + ${order.id}">#1</span>
                  &middot;
                  <span th:text="${#temporals.format(order.createdAt, 'HH:mm')}">12:30</span>
                </div>
              </div>
            </div>
            <div>
              <span class="order-status badge" th:classappend="${order.status.toString().toLowerCase()}" th:text="${order.status}">NEW</span>
            </div>
          </div>

          <div class="usher-order-body">
            <div class="guest-block">
              <div class="guest-name" th:text="${order.ticket != null ? order.ticket.holderName : 'Unknown guest'}">Guest</div>
              <div class="guest-ticket small muted" th:text="${order.ticket != null ? order.ticket.qrCode : 'N/A'}">QR</div>
            </div>

            <ul class="line-items" aria-label="Order items">
              <li th:each="item : ${order.items}">
                <span class="item-name" th:text="${item.menuItem.name}">Item</span>
                <span class="item-qty muted" th:text="'x' + ${item.qty}">x1</span>
              </li>
            </ul>
          </div>

          <div class="usher-order-actions">
            <form th:action="@{|/e/${event.code}/usher/orders/${order.id}/advance|}" method="post" style="display:inline-block;">
              <div th:if="${bucket.status == T(com.fbcorp.gleo.domain.OrderStatus).READY and requirePin}" style="margin-bottom:8px;">
                <input th:id="'pin-' + ${order.id}" name="pin" type="password" class="qty-input" placeholder="Vendor PIN" required>
              </div>
              <button class="btn btn-primary" type="submit" th:text="${statusActionLabels[bucket.status]}">Advance</button>
            </form>

            <form th:if="${bucket.status == T(com.fbcorp.gleo.domain.OrderStatus).NEW or bucket.status == T(com.fbcorp.gleo.domain.OrderStatus).PREPARING}"
                  th:action="@{|/e/${event.code}/usher/orders/${order.id}/cancel|}"
                  method="post" style="display:inline-block;margin-left:8px;">
              <button class="btn btn-muted" type="submit" onclick="return confirm('Cancel order?');">Cancel</button>
            </form>

            <div th:if="${bucket.status == T(com.fbcorp.gleo.domain.OrderStatus).COMPLETED}" class="small muted">Completed</div>
            <div th:if="${bucket.status == T(com.fbcorp.gleo.domain.OrderStatus).CANCELLED}" class="small muted">Cancelled</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
<script>
  function submitVendorStatus(status) {
    const select = document.getElementById('vendor-select');
    if (!select) return alert('No vendors available');
    const vendorId = select.value;
    if (!vendorId) return alert('Please choose a vendor');

    // Build a form and submit so Spring's CSRF and endpoints work as usual
    // Use fetch to POST without navigating away from the page
    const csrfParamEl = document.getElementById('_csrf_param');
    const csrfTokenEl = document.getElementById('_csrf_token');

    const formData = new URLSearchParams();
    formData.append('status', status);

    const headers = {
      'Content-Type': 'application/x-www-form-urlencoded'
    };
    if (csrfParamEl && csrfTokenEl) {
      // Spring typically accepts X-CSRF-TOKEN header or form param; include header for fetch
      headers['X-CSRF-TOKEN'] = csrfTokenEl.value;
      // also include the param name in the body in case server expects it
      formData.append(csrfParamEl.value, csrfTokenEl.value);
    }

    fetch('/api/vendors/' + vendorId + '/status', {
      method: 'POST',
      headers: headers,
      body: formData.toString(),
      credentials: 'same-origin'
    }).then(resp => {
      if (!resp.ok) throw new Error('Server returned ' + resp.status);
      setToast('Vendor status updated to ' + status + '.', 'success');
      // Update small status label next to select
      const sel = document.getElementById('vendor-select');
      const opt = sel.options[sel.selectedIndex];
      if (opt) opt.setAttribute('data-status', status);
      updateVendorStatusLabel();
    }).catch(err => {
      console.error(err);
      setToast('Unable to update vendor status: ' + err.message, 'error');
    });
  }

  function updateVendorStatusLabel() {
    const sel = document.getElementById('vendor-select');
    const label = document.getElementById('vendor-status');
    if (!sel || !label) return;
    const opt = sel.options[sel.selectedIndex];
    const st = opt ? opt.getAttribute('data-status') : null;
    label.textContent = st ? st.charAt(0).toUpperCase() + st.slice(1).toLowerCase() : '';
  }

  // Simple toast helper
  function setToast(message, type) {
    const existing = document.getElementById('vendor-toast');
    if (existing) existing.remove();
    const toast = document.createElement('div');
    toast.id = 'vendor-toast';
    toast.className = 'toast ' + (type === 'error' ? 'toast-error' : 'toast-success');
    toast.style.position = 'fixed';
    toast.style.right = '24px';
    toast.style.bottom = '24px';
    toast.style.zIndex = '1000';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => { toast.remove(); }, 3500);
  }

  function refreshBoard() {
    fetch('/e/' + EVENT_CODE + '/usher/live')
      .then(response => response.text())
      .then(html => {
        const boardContent = document.getElementById('usher-board-live');
        boardContent.innerHTML = html;
      })
      .catch(err => {
        console.error('Error refreshing board:', err);
      });
  }

  // Initialize label on load and update on selection change
  document.addEventListener('DOMContentLoaded', function() {
    const sel = document.getElementById('vendor-select');
    if (sel) {
      sel.addEventListener('change', updateVendorStatusLabel);
      updateVendorStatusLabel();
    }

    // Initialize WebSocket connection
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);
    stompClient.connect({}, function() {
      console.log('WebSocket connected!');
      
      // Subscribe to order updates for this event
      stompClient.subscribe('/topic/orders/' + EVENT_CODE, function(message) {
        console.log('Received order update:', message.body);
        // Refresh the board to show the latest orders
        refreshBoard();
      });
    }, function(err) {
      console.error('WebSocket connection error:', err);
    });
  });
</script>
</body>
</html>
