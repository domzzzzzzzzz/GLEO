<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title th:text="${vendor.name} + ' - ' + ${event.name}">Vendor Menu</title>
  <link href="/css/tailwind.css" rel="stylesheet">
  <link href="/css/modern.css?v=20241110" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@2.0.2"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>
  <script src="/js/cart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
</head>
<body>
<div class="page">
  <div th:replace="fragments/nav :: top(${event}, ${cartSummary})"></div>
  <div class="vendor-page-head">
    <a th:href="@{|/e/${event.code}|}" class="btn btn-muted btn-sm">&larr; Back to vendors</a>
    <h2 th:text="${vendor.name}">Vendor</h2>
    <span id="vendor-status" style="display:none;" th:attr="data-vendor-id=${vendor.id}" th:text="${vendor.status != null ? vendor.status : 'AVAILABLE'}">AVAILABLE</span>
  </div>

  <!-- Multi-vendor lock banner (only blocks adding, not viewing) -->
  <div class="vendor-lock-banner" 
       th:if="${singleVendorLocked}">
    <div class="vendor-lock-banner__content">
      <strong>Single-vendor cart active</strong>
      <p th:text="'Your cart already contains items from ' + ${lockedVendorName} + '. Clear your cart to order from this vendor.'">
        Your cart already contains items from another vendor. Clear your cart to order from this vendor.
      </p>
      <form th:action="@{|/e/${event.code}/cart/clear|}" method="post">
        <button type="submit" class="btn btn-outline btn-sm">Clear Cart</button>
      </form>
    </div>
  </div>


  <!-- Professional Toast Notification (bottom center, never covers cart/nav) -->
  <div id="toast-region">
    <div th:if="${successMessage}" class="toast-modern animate-in">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
        <circle cx="10" cy="10" r="10" fill="#10b981"/>
        <path d="M8 13l-3-3 1.4-1.4L8 10.2l5.6-5.6L15 6l-7 7z" fill="#fff"/>
      </svg>
      <span th:text="${successMessage}">Item added to cart!</span>
    </div>
  </div>

  <div id="toast-region"></div>

  <div class="vendor-photo vendor-photo--hero"
       th:classappend="${vendor.imagePath} == null ? ' vendor-photo--empty' : ''">
    <img th:if="${vendor.imagePath != null}"
         th:src="${vendor.imagePath}"
         th:alt="${vendor.name} + ' preview'">
    <span th:if="${vendor.imagePath == null}"
          th:text="${#strings.isEmpty(vendor.name) ? 'V' : #strings.toUpperCase(#strings.substring(vendor.name,0,1))}">V</span>
  </div>

  <div class="layout-columns">
    <section>
      <h3 class="section-title">Menu</h3>
      <div>
        <div th:each="entry : ${itemsByCategory}">
          <h4 th:text="${entry.key}" style="margin-top:1.25rem;margin-bottom:0.5rem;color:var(--gray-700);">Category</h4>
          <div class="menu-grid">
            <div class="menu-card" th:each="item : ${entry.value}">
          <div class="menu-card-layout">
            <div class="menu-item-image" th:classappend="${item.imagePath == null} ? 'menu-item-image--empty' : ''">
              <img th:if="${item.imagePath != null}" 
                   th:src="${item.imagePath}" 
                   th:alt="${item.name} + ' image'">
              <span th:if="${item.imagePath == null}" 
                    class="menu-item-placeholder"
                    th:text="${#strings.isEmpty(item.name) ? 'üçΩÔ∏è' : #strings.toUpperCase(#strings.substring(item.name,0,1))}">üçΩÔ∏è</span>
            </div>
            <div class="menu-item-info">
              <h4 th:text="${item.name}">Item name</h4>
              <div class="menu-meta">
                <span class="menu-price" th:text="${#numbers.formatDecimal(item.price, 1, 'DEFAULT', 2, 'DEFAULT')} + ' EGP'">0.00</span>
                <span class="menu-status" th:classappend="${item.available} ? 'menu-status--available' : 'menu-status--unavailable'" th:text="${item.available} ? 'Available' : 'Sold out'">status</span>
              </div>
            </div>
          </div>
          <form th:action="@{|/e/${event.code}/cart/add|}" method="post"
                class="menu-actions">
            <input type="hidden" name="itemId" th:value="${item.id}"/>
            <div class="qty-stepper-inline">
              <button type="button" class="qty-btn qty-btn-minus" onclick="this.nextElementSibling.stepDown()">‚àí</button>
              <input class="qty-input-stepper" type="number" name="qty" min="1" max="99" value="1"/>
              <button type="button" class="qty-btn qty-btn-plus" onclick="this.previousElementSibling.stepUp()">+</button>
            </div>
      <button class="btn btn-primary btn-add-cart" type="submit"
        th:classappend="${singleVendorLocked} ? ' btn-locked' : ''"
        th:disabled="${!item.available or singleVendorLocked}">
              <span th:text="${!item.available} ? 'Unavailable' : (singleVendorLocked ? 'Locked' : 'Add to cart')">Add to cart</span>
            </button>
          </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Removed fixed View Cart bar per request -->
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (window.setupCartPanel) {
      window.setupCartPanel();
    }
    
    // Set up vendor status polling
    const statusEl = document.getElementById('vendor-status');
    if (statusEl) {
      const vendorId = statusEl.getAttribute('data-vendor-id');
      if (vendorId) {
        // Initial status check and then every 10 seconds
        checkVendorStatus(vendorId);
        setInterval(() => checkVendorStatus(vendorId), 10000);
      }
    }
  });

    function updateVendorStatusUI(status) {
        const statusEl = document.getElementById('vendor-status');
        if (statusEl) {
          statusEl.textContent = status;
          
          // Update menu items based on vendor status
          const menuItems = document.querySelectorAll('.menu-card button');
          menuItems.forEach(btn => {
            if (status === 'BREAK' || status === 'BUSY') {
              btn.disabled = true;
              const btnText = btn.querySelector('span');
              if (btnText) {
                btnText.textContent = status === 'BREAK' ? 'On Break' : 'Busy';
              }
            } else {
              // Only enable if the item itself is available
              const form = btn.closest('form');
              const menuCard = btn.closest('.menu-card');
              const metaEl = menuCard ? menuCard.querySelector('.menu-meta') : null;
              const available = menuCard && metaEl && !metaEl.textContent.includes('Sold out');
              btn.disabled = !available;
              const btnText = btn.querySelector('span');
              if (btnText) {
                btnText.textContent = available ? 'Add to cart' : 'Unavailable';
              }
            }
          });
        }
    }

    // Initial status check
    function checkVendorStatus(vendorId) {
      fetch('/api/vendors/' + vendorId + '/status')
        .then(resp => resp.json())
        .then(status => updateVendorStatusUI(status))
        .catch(console.error);
    }
    
    // WebSocket connection for real-time updates
    const statusEl = document.getElementById('vendor-status');
    if (statusEl && typeof SockJS !== 'undefined' && typeof StompJs !== 'undefined') {
      const vendorId = statusEl.getAttribute('data-vendor-id');
      const eventCode = window.location.pathname.split('/')[2]; // Extract from /e/{eventCode}/...
      
      try {
        const stompClient = new StompJs.Client({
          webSocketFactory: function () {
            return new SockJS('/ws');
          },
          onConnect: function(frame) {
            stompClient.subscribe('/topic/vendor-status/' + eventCode, function(message) {
              const update = JSON.parse(message.body);
              if (update.vendorId == vendorId) {
                updateVendorStatusUI(update.status);
              }
            });
          },
          onStompError: function(frame) {
            console.error('STOMP error:', frame);
          }
        });
        stompClient.activate();
      } catch(e) {
        console.warn('WebSocket not available:', e);
      }
    }
    
    // HTMX event listener for cart panel updates
    document.addEventListener('htmx:afterSwap', function (event) {
      if (event.detail && event.detail.target && event.detail.target.id === 'cart-panel') {
        if (window.setupCartPanel) {
          window.setupCartPanel();
        }
      }
    });
  </script>
</body>
<style>
  .toast-modern {
    position: fixed;
    left: 50%;
    bottom: 2.5rem;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 1rem 1.75rem;
    border-radius: 1.25rem;
    box-shadow: 0 8px 32px rgba(16,185,129,0.18);
    display: flex;
    align-items: center;
    gap: 0.85rem;
    font-weight: 600;
    font-size: 1.05rem;
    z-index: 1200;
    min-width: 220px;
    max-width: 90vw;
    animation: toastIn 0.35s cubic-bezier(0.4,0,0.2,1), toastOut 0.45s cubic-bezier(0.4,0,0.2,1) 2.5s forwards;
  }
  .toast-modern svg {
    flex-shrink: 0;
    width: 22px;
    height: 22px;
  }
  @keyframes toastIn {
    from { opacity: 0; transform: translateX(-50%) translateY(30px); }
    to   { opacity: 1; transform: translateX(-50%) translateY(0); }
  }
  @keyframes toastOut {
    from { opacity: 1; transform: translateX(-50%) translateY(0); }
    to   { opacity: 0; transform: translateX(-50%) translateY(30px); }
  }
  @media (max-width: 640px) {
    .toast-modern {
      bottom: 1.25rem;
      padding: 0.85rem 1.1rem;
      font-size: 0.97rem;
      min-width: 0;
      max-width: 98vw;
    }
    .toast-modern svg { width: 20px; height: 20px; }
  }
</style>
</html>
